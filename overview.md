# JDrupes Builder

JDrupes Builder ("jdbld" for short) is a
[build automation tool](https://en.wikipedia.org/wiki/Build_system_(software_development))
that uses Java for its configuration and centers around resources.

Here's the source code for a sample build configuration, which will be explained
in more detail below:

```java
public class SimpleAppBuilder extends AbstractProject {

    public SimpleAppBuilder() {
        super(name("simple-app"));
        generator(JavaCompiler::new).addSources(Path.of("src"), "**/*.java");
        generator(AppJarGenerator::new).add(this).mainClass("jdbld.demo.simpleapp.App");
    }
}
```

In jdbld's terminology, a build system is a provider for resources.
It is implemented as a graph of [org.jdrupes.builder.api.ResourceProvider]s,
which provide [org.jdrupes.builder.api.Resource]s in response to
[org.jdrupes.builder.api.ResourceRequest]s. The topmost layer of the
build system's configuration is a collection of classes that implement
the special resource provider [org.jdrupes.builder.api.Project]. Projects
provide resources by requesting them from other
[org.jdrupes.builder.api.ResourceProvider]s. 

![Builder classes](project-provider-classes.svg)

## Single project builds

In a single project build configuration, an instance of the defined
project class provides all resources by requesting them from its 
[org.jdrupes.builder.api.Generator]s, which are another special kind of
[org.jdrupes.builder.api.ResourceProvider]s.

![Single project classes](single-project-classes.svg)

A build configuration (a.k.a project) for a simple Java application
is shown below. It shows the objects that are generated by the source
code above.

![Simple app jar project](simple-appjar-project.svg)

The project contains two generators. The first is a
[org.jdrupes.builder.java.JavaCompiler], which provides resources of type
[org.jdrupes.builder.java.ClassTree] to the project. The second
generator is an [org.jdrupes.builder.java.AppJarGenerator]. This
generator provides resources of type [org.jdrupes.builder.java.JarFile].
It uses the [org.jdrupes.builder.java.ClasspathElement]s provided by the
project as source for the jar's content.

You might wonder why the app jar generator goes back to the project
to retrieve the classpath elements. Looking at the API, we could also have
the app jar generator reference the Java compiler directly. There are two
reasons for this. First, a user might request the class tree from the project
(instead of the application jar). The second reason
will become clear when we discuss a multi-project build configuration,
in which a project can provide resources from another project in addition to
those obtained from its generators.

For further clarification, the diagram below shows the sequence of operations
as they happen when a user requests the application jar from the project.  

![Simple app jar project](build-appjar-project.svg)


The focus on resources usually works. It fails when you want
the builder to do something that cannot really be described as
creating a resource. The most prominent example of this is probably
cleaning a build. What does this provide? Well, how about "cleanliness"?
Depending on your point of view, "cleanliness" may be the absence of
something, but you could also argue that "cleanliness"
provides something.

@startuml project-provider-classes.svg
interface ResourceProvider
interface ResourceRequest
interface Resource
interface Project
ResourceProvider <|-right- Project : "     "
Project --> "*" ResourceProvider : delegates to
ResourceProvider .down.> Resource
ResourceProvider .down.> ResourceRequest  
@enduml

@startuml single-project-classes.svg
interface ResourceProvider
interface Project
interface Generator
ResourceProvider <|-right- Project : "     "
Project <|.right. SimpleAppProject 
Generator --|> ResourceProvider
SimpleAppProject *--> "*" Generator
@enduml

@startuml simple-appjar-project.svg
object "project: SimpleAppBuilder" as project
object "compiler: JavaCompiler" as compiler
object "appJarGenerator: AppJarGenerator" as appJarGenerator
project *-right-> compiler : <<generator>>
project *--> appJarGenerator : <<generator>>
appJarGenerator --> project : <<provider>>
@enduml

@startuml build-appjar-project.svg
hide footbox

actor User as user
user -> project : provide(AppJarFileType)
activate project
project -> appJarGenerator : provide(AppJarFileType)
activate appJarGenerator
appJarGenerator -> project : provide(ClasspathElementType)
activate project
project -> compiler : provide(ClasspathElementType)
activate compiler
compiler --> project: ClassTree
deactivate compiler
project -> appJarGenerator : ClassTree
deactivate project
appJarGenerator -> project : JarFile
deactivate appJarGenerator
project -> user : JarFile
deactivate project
@enduml
